#!/bin/sh
#
# Configure script for 'ksh'
# Copyright (c) 2012-2018 Bertrand Janin <b@janin.com>
#
#

VERSION="6.1"


# Some shells have shitty echos
alias echo=/bin/echo


# Attempt tp guess the best CC.
if [ -z "$CC" ]; then
	if cc -v 1>/dev/null 2>/dev/null; then
		export CC=cc
	else
		export CC=gcc
	fi
fi


# generate_makefile() - Generate the main Makefile
# $1 - file to append at the end
generate_makefile() {
	echo "# Automagically generated by 'configure'"
	echo

	echo "CFLAGS+=$CFLAGS -std=c99 -pedantic"
	echo "CFLAGS+=-Wall -W -Wpointer-arith -Wbad-function-cast -Wcast-qual"
	echo "CFLAGS+=-Wstrict-prototypes -Wmissing-prototypes"
	echo "CFLAGS+=-Wmissing-declarations -Wnested-externs -Winline"
	echo "CFLAGS+=-DVERSION=\\\"$VERSION\\\" $X_CFLAGS"

	if [ "$DEBUG_MODE" = "Y" ]; then
		echo "CFLAGS+=-Wall -ggdb -O0"
	else
		echo "CFLAGS+=-Wall -O2"
	fi

	if [ -n "$X_OBJECTS" ]; then
		echo "EXTRA_OBJECTS=$X_OBJECTS"
	fi

	echo "CC?=$CC"
	echo "PREFIX?=$PREFIX"
	echo "MANDIR=$MANDIR"

	cat "$1"
}


# usage() - Spit out basic help
usage() {
	echo "usage: ./configure [-h] [-d] [platform]"
	echo
	echo "    -h   this help screen."
	echo "    -d   configure for debug mode (-ggdb -O1)"
	echo
	echo "By default, this script will attempt to detect your OS and will guess the most"
	echo "appropriate configuration. If it gets your system wrong, you can force it,"
	echo "here is the list of ''supported'' platforms:"
	echo
	echo "    bsd     - OpenBSD, FreeBSD, OS X, Darwin, ..."
	echo "    linux   - Linux"
	exit
}


# not_found() - Exit 'cause we're missing something
not_found() {
	message="$1"
	echo "not found"
	echo
	echo ERROR: $message
	exit 2
}


# Command-line arguments
while true; do
	case "$1" in
		-h|--help)
			usage
			exit 2
			;;

		-d|--debug)
			echo "Debug mode... enabled"
			DEBUG_MODE="Y"
			shift
			;;

		--prefix=*)
			PREFIX="${1##--prefix=}"
			shift
			;;

		--mandir=*)
			MANDIR="${1##--mandir=}"
			shift
			;;

		# Skip all random long opts passed by packagers thinking this
		# is autoconf-compatible.
		--*)
			shift
			;;

		*)
			break
			;;
	esac
done


# Detect platform
echo -n "Target platform... "
OS=`uname`
if [ -n "$1" ]; then
	OS="$1"
fi
echo $OS


# Platform-specific configuration
case $OS in
	Linux|Unix|POSIX)
		X_CFLAGS="-D_GNU_SOURCE"
		MANDEST="share/man"
		;;

	*BSD)
		;;

	Darwin)
		MANDEST="share/man"
		;;

	*)
		echo
		echo "Sorry but '$OS' is currently unsupported, you can attemp 'bsd' or 'linux' as"
		echo "target and cross your fingers. In order to do that you just need to give either"
		echo "one as parameter to ./configure. You can get the official list of supported "
		echo "platform with ./configure -l"
		exit
esac


# Default paths
[ -z "$PREFIX" ]	&& PREFIX="/usr/local"
[ -z "$MANDEST" ]	&& MANDEST="man"
[ -z "$MANDIR" ]	&& MANDIR="${PREFIX}/${MANDEST}"


# Check for make
echo -n "make... "
cat <<EOF > fake_makefile
all:
	@echo found
EOF
if ! make -f fake_makefile 1>/dev/null 2>/dev/null; then
	not_found "Make not found (try to install make or gmake)"
fi
echo found
rm -f fake_makefile*


# Check if we have a working cc
echo -n "cc... "
cat <<EOF > fake_cc.c
#include <stdio.h>
main() { printf("woot\n"); }
EOF
if ! ${CC} fake_cc.c -o /dev/null 1>/dev/null 2>/dev/null; then
	not_found "No C compiler found (try to install gcc or clang)"
fi
echo ${CC}
rm -f fake_cc*


# Check if we have strlcpy
echo -n "strlcpy... "
cat <<EOF > fake_strlcpy.c
main() { char buf[32]; strlcpy(buf, "woot", sizeof(buf)); }
EOF
if ! ${CC} fake_strlcpy.c -o /dev/null 1>/dev/null 2>/dev/null; then
	echo "not found (we'll use ours)"
	X_OBJECTS="$X_OBJECTS strlcpy.o"
	CFLAGS="$CFLAGS -DHAS_NO_STRLCPY"
else
	echo yes
fi
rm -f fake_strlcpy*


# Check if we have strlcat
echo -n "strlcat... "
cat <<EOF > fake_strlcat.c
main() { char buf[32]; strlcat(buf, "woot", sizeof(buf)); }
EOF
if ! ${CC} fake_strlcat.c -o /dev/null 1>/dev/null 2>/dev/null; then
	echo "not found (we'll use ours)"
	X_OBJECTS="$X_OBJECTS strlcat.o"
	CFLAGS="$CFLAGS -DHAS_NO_STRLCAT"
else
	echo yes
fi
rm -f fake_strlcat*


# Check if we have strtonum
echo -n "strtonum... "
cat <<EOF > fake_strtonum.c
main() { int i; const char *errstr; i = strtonum("42", 1, 64, &errstr); }
EOF
if ! ${CC} fake_strtonum.c -o /dev/null 1>/dev/null 2>/dev/null; then
	echo "not found (we'll use ours)"
	X_OBJECTS="$X_OBJECTS strtonum.o"
	CFLAGS="$CFLAGS -DHAS_NO_STRTONUM"
else
	echo yes
fi
rm -f fake_strtonum*

# Check if we have pledge (yeah right)
echo -n "pledge... "
cat <<EOF > fake_pledge.c
main() { int i; i = pledge("", ""); }
EOF
if ! ${CC} fake_pledge.c -o /dev/null 1>/dev/null 2>/dev/null; then
	echo "not found (we'll use ours)"
	X_OBJECTS="$X_OBJECTS pledge.o"
	CFLAGS="$CFLAGS -DHAS_NO_PLEDGE"
else
	echo yes
fi
rm -f fake_pledge*

# Check if we have setresgid
echo -n "setresgid... "
cat <<EOF > fake_setresgid.c
main() { int i; i = setresgid(9999, 9999, 9999); }
EOF
if ! ${CC} fake_setresgid.c -o /dev/null 1>/dev/null 2>/dev/null; then
	echo "not found (we'll use ours)"
	X_OBJECTS="$X_OBJECTS setresgid.o"
	CFLAGS="$CFLAGS -DHAS_NO_SETRESGID"
else
	echo yes
fi
rm -f fake_setresgid*

# Check if we have setresuid
echo -n "setresuid... "
cat <<EOF > fake_setresuid.c
main() { int i; i = setresuid(9999, 9999, 9999); }
EOF
if ! ${CC} fake_setresuid.c -o /dev/null 1>/dev/null 2>/dev/null; then
	echo "not found (we'll use ours)"
	X_OBJECTS="$X_OBJECTS setresuid.o"
	CFLAGS="$CFLAGS -DHAS_NO_SETRESUID"
else
	echo yes
fi
rm -f fake_setresuid*

# Check if we have stravis
echo -n "stravis... "
cat <<EOF > fake_stravis.c
#include <vis.h>
main() { int i; i = stravis(NULL, NULL, 0); }
EOF
if ! ${CC} fake_stravis.c -o /dev/null 1>/dev/null 2>/dev/null; then
	echo "not found (we'll use ours)"
	X_OBJECTS="$X_OBJECTS stravis.o"
	CFLAGS="$CFLAGS -DHAS_NO_STRAVIS"
else
	echo yes
fi
rm -f fake_stravis*

# Check if we have reallocarray
echo -n "reallocarray... "
cat <<EOF > fake_reallocarray.c
#include <stdlib.h>
main() { char *c; c = reallocarray(NULL, 0, 0); }
EOF
if ! ${CC} fake_reallocarray.c -o /dev/null 1>/dev/null 2>/dev/null; then
	echo "not found (we'll use ours)"
	X_OBJECTS="$X_OBJECTS reallocarray.o"
	CFLAGS="$CFLAGS -DHAS_NO_REALLOCARRAY"
else
	echo yes
fi
rm -f fake_reallocarray*

generate_makefile Makefile.src > Makefile
generate_makefile src/Makefile.src > src/Makefile

echo
echo "Configured for '$OS', run 'make' (or 'gmake') to compile."

